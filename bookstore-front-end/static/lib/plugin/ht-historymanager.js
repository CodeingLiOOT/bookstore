!function(G,V,a){"use strict";var h="ht",X=G[h],d=X.Default,j=d.def,K=d.getInternal();X.HistoryManager=function(S){this._histories=[],this.setDataModel(S)},j(X.HistoryManager,V,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var G=this;G._betweenTransaction++,1===G._betweenTransaction&&(G._transactionHistories=[])}},endTransaction:function(){if(!this._disabled){var C=this,a=C._histories;C._betweenTransaction>0&&C._betweenTransaction--,0===C._betweenTransaction&&(C._transactionHistories&&C._transactionHistories.length&&(a=a.slice(0,C._historyIndex+1),a.push(C._transactionHistories),a.length>C._maxHistoryCount&&(a=a.slice(a.length-C._maxHistoryCount)),C.setHistories(a),C.setHistoryIndex(a.length-1,!0)),delete C._transactionHistories)}},setDataModel:function(J){var C=this,W=C._dataModel;W!==J&&(W&&(delete W._historyManager,W.ump(C.handleDataModelPropertyChange,C),W.umm(C.$5p,C),W.umd(C.$6p,C),W.removeHierarchyChangeListener(C.handleHierarchyChange,C),W.removeIndexChangeListener(C.handleIndexChange,C)),C._dataModel=J,J&&(J._historyManager=C,J.mp(C.handleDataModelPropertyChange,C),J.mm(C.$5p,C),J.md(C.$6p,C),J.addHierarchyChangeListener(C.handleHierarchyChange,C),J.addIndexChangeListener(C.handleIndexChange,C)),C.fp("dataModel",W,J),C.clear())},setHistoryIndex:function(t,L){var W=this,A=W._historyIndex,n=W._histories.length;if(-1>t?t=-1:t>=n&&(t=n-1),A!==t){if(!L){var i=t-A;i>0?W.$2p(i):0>i&&W.$1p(-i)}W._historyIndex=t,W.fp("historyIndex",A,t),W.dataModel&&W.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(o){var y=this,T=y._histories,u=y._maxHistoryCount;(!o||0>=o)&&(o=10),u!==o&&(y._maxHistoryCount=o,y.fp("maxHistoryCount",u,o),T.length>o&&y.clear())},cloneValue:function(Z){return X.Default.clone(Z)},isPropertyUndoable:function(g){return g&&!this.ignoredPropertyMap[g]},$5p:function(s){this.handleChange(s,s.kind)},$6p:function(G){this.handleChange(G,"property")},handleHierarchyChange:function(Z){this.handleChange(Z,"hierarchy")},handleIndexChange:function(_){this.handleChange(_,"index")},handleDataModelPropertyChange:function(V){this.handleChange(V,"dataModelProperty")},toChildrenInfo:function(N){var z={};return z.data=N,z.children=[],N.eachChild(function(y){z.children.push(this.toChildrenInfo(y))},this),z},restoreChildren:function(U){var b=U.data;U.children.forEach(function(X){var Q=X.data;Q.getParent()!==b&&b.addChild(Q),this._dataModel.contains(Q)||this._dataModel.add(Q),this.restoreChildren(X)},this)},handleChange:function(T,V){var K=this;if(!K._disabled&&!K._isUndoRedoing){var j,r=(K._histories,T.data),J=T.property;if("property"===V)K.isPropertyUndoable(J,r)&&(j={kind:V,data:r,property:J,oldValue:K.cloneValue(T.oldValue,r,J),newValue:K.cloneValue(T.newValue,r,J),event:T});else if("hierarchy"===V||"index"===V)j={kind:V,data:r,oldIndex:T.oldIndex,newIndex:T.newIndex,event:T};else if("clear"===V)j={kind:V,json:T.json,event:T};else if("add"===V){if(j={kind:V,data:r,event:T,childrenInfo:this.toChildrenInfo(r),parent:r.getParent()},j.parent){var Q=K._dataModel.getSiblings(r);j.siblingsIndex=Q.indexOf(r)}r instanceof X.Node&&(j.host=r.getHost(),j.attaches=r.getAttaches()?r.getAttaches().toArray():a),r instanceof X.Edge&&(j.source=r.getSource(),j.target=r.getTarget())}else"remove"===V?j={kind:V,data:r,event:T}:"dataModelProperty"===V&&(j={kind:V,property:J,oldValue:K.cloneValue(T.oldValue,r,J),newValue:K.cloneValue(T.newValue,r,J),event:T});K.addHistory(j)}},addHistory:function(V){var b=this;if(V)if(b._betweenTransaction){var A=!1;if("property"===V.kind||"dataModelProperty"===V.kind)for(var $=b._transactionHistories.length-1;$>=0;$--){var d=b._transactionHistories[$];if(V.kind===d.kind&&V.property===d.property&&V.data===d.data){V.oldValue=d.oldValue,b._transactionHistories[$]=V,A=!0;break}}A||b._transactionHistories.push(V)}else{var N=b._histories;N=N.slice(0,b._historyIndex+1),N.push([V]),N.length>b._maxHistoryCount&&(N=N.slice(N.length-b._maxHistoryCount)),b.setHistories(N),b.setHistoryIndex(N.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(x){(!x||0>=x)&&(x=1),this.setHistoryIndex(this._historyIndex-x)},$1p:function(k){if(this.canUndo()){var M,J=this,U=J._dataModel,n=J._histories,c=J._historyIndex;for(J._isUndoRedoing=!0,d.setIsolating(!0);k>0;){if(c>=0&&c<n.length){M=n[c],c--;for(var t=M.length-1;t>=0;t--){var e=M[t],r=e.kind,Z=e.data,a=e.property,h=e.event,q=this.cloneValue(e.oldValue,Z,a);if(e.undo)e.undo();else if("add"===r)U.remove(Z,{keepChildren:!0});else if("remove"===r)U.contains(Z)||U.add(Z,h.rootsIndex,h.datasIndex);else if("clear"===r)U.deserialize(d.clone(e.json));else if("property"===r)if("parent"===a)q?q.addChild(Z,h.oldIndex):(Z.setParent(q),h.oldIndex>=0&&U.moveTo(Z,h.oldIndex));else{var D=null;0===a.indexOf("a:")?(D="attr",a=a.replace("a:","")):0===a.indexOf("s:")&&(D="style",a=a.replace("s:","")),K.setPropertyValue(Z,D,a,q)}else if("dataModelProperty"===r){var D=null;0===a.indexOf("a:")?(D="attr",a=a.replace("a:","")):0===a.indexOf("s:")&&(D="style",a=a.replace("s:","")),K.setPropertyValue(U,D,a,q)}else"hierarchy"===r?U.moveTo(Z,e.oldIndex):"index"===r&&U.moveToIndex(Z,e.oldIndex)}}k--}d.setIsolating(!1),delete J._isUndoRedoing}},redo:function(G){(!G||0>=G)&&(G=1),this.setHistoryIndex(this._historyIndex+G)},$2p:function(t){if(this.canRedo()){var $,S=this,F=S._dataModel,W=S._histories,i=S._historyIndex;for(S._isUndoRedoing=!0,d.setIsolating(!0);t>0;){if(i>=-1&&i<W.length-1){i++,$=W[i];for(var q=0;q<$.length;q++){var Y=$[q],h=Y.kind,P=Y.data,D=Y.property,I=Y.event,_=this.cloneValue(Y.newValue,P,D);if(Y.redo)Y.redo();else if("add"===h)Y.parent&&!P.getParent()&&Y.parent.addChild(P,Y.siblingsIndex),F.contains(P)||F.add(P,I.rootsIndex,I.datasIndex),this.restoreChildren(Y.childrenInfo),P instanceof X.Node&&(P.setHost(Y.host),Y.attaches&&Y.attaches.forEach(function(g){g.setHost(P)})),P instanceof X.Edge&&(P.setSource(Y.source),P.setTarget(Y.target));else if("remove"===h)F.remove(P);else if("clear"===h)F.clear();else if("property"===h)if("parent"===D)_?_.addChild(P,I.newIndex):(P.setParent(_),I.newIndex>=0&&F.moveTo(P,I.newIndex));else{var E=null;0===D.indexOf("a:")?(E="attr",D=D.replace("a:","")):0===D.indexOf("s:")&&(E="style",D=D.replace("s:","")),K.setPropertyValue(P,E,D,_)}else if("dataModelProperty"===h){var E=null;0===D.indexOf("a:")?(E="attr",D=D.replace("a:","")):0===D.indexOf("s:")&&(E="style",D=D.replace("s:","")),K.setPropertyValue(F,E,D,_)}else"hierarchy"===h?F.moveTo(P,Y.newIndex):"index"===h&&F.moveToIndex(P,Y.newIndex)}}t--}d.setIsolating(!1),delete S._isUndoRedoing}},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);